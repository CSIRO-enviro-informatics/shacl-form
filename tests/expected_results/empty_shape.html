<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create New Person</title>
</head>
<body>
    <h1>Create New Person</h1>
    <form method="POST" id="form">
        <input type="submit" value="Submit" />
    </form>
</body>
</html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="jquery-validation/jquery.validate.js"></script>
<script src="jquery-validation/additional-methods.js"></script>
<script>
    $.validator.addMethod("equalTo", function(value, element, params) {
        var subject_value;
        var object_value;
        if ($(element).attr("type") == "checkbox")
            subject_value = $(element).is(":checked");
        else
            subject_value = $(element).val();
        if ($(params).attr("type") == "checkbox")
            object_value = $(params + ":enabled").is(":checked");
        else
            object_value = $(params + ":enabled").val();
        return this.optional(element) || subject_value == object_value;
    }, "Message" );
    $.validator.addMethod("notEqualTo", function(value, element, params) {
        var subject_value;
        var object_value;
        if ($(element).attr("type") == "checkbox")
            subject_value = $(element).is(":checked");
        else
            subject_value = $(element).val();
        if ($(params).attr("type") == "checkbox")
            object_value = $(params + ":enabled").is(":checked");
        else
            object_value = $(params + ":enabled").val();
        return this.optional(element) || subject_value != object_value;
    }, "Message" );
    $.validator.addMethod("lessThan", function(value, element, params) {
        var subject_value;
        var object_value;
        if ($(element).attr("type") == "checkbox")
            subject_value = $(element).is(":checked");
        else
            subject_value = $(element).val();
        if ($(params).attr("type") == "checkbox")
            object_value = $(params + ":enabled").is(":checked");
        else
            object_value = $(params + ":enabled").val();
        return this.optional(element) || subject_value < object_value;
    }, "Message" );
    $.validator.addMethod("lessThanEqual", function(value, element, params) {
        var subject_value;
        var object_value;
        if ($(element).attr("type") == "checkbox")
            subject_value = $(element).is(":checked");
        else
            subject_value = $(element).val();
        if ($(params).attr("type") == "checkbox")
            object_value = $(params + ":enabled").is(":checked");
        else
            object_value = $(params + ":enabled").val();
        return this.optional(element) || subject_value <= object_value;
    }, "Message" );
    $("#form").validate({
        ignore: ":input[disabled]",
        equalTo: ":input[equalTo]",
        notEqualTo: ":input[notEqualTo]",
        lessThan: ":input[lessThan]",
        lessThanEqual: ":input[lessThanEqual]"
    });
    $(":input[equalTo]").each(function(index) {
        $(this).rules("add", {
            messages: { equalTo: $.validator.format("Must be equal to {0}",$($(this).attr("equalTo")).attr("label")) }
        });
    });
    $(":input[notEqualTo]").each(function(index) {
        $(this).rules("add", {
            messages: {
                notEqualTo: $.validator.format("Must not be equal to {0}",$($(this).attr("notEqualTo")).attr("label"))
            }
        });
    });
    $(":input[lessThan]").each(function(index) {
        $(this).rules("add", {
            messages: {
                lessThan: $.validator.format("Must be less than {0}",$($(this).attr("lessThan")).attr("label"))
            }
        });
    });
    $(":input[lessThanEqual]").each(function(index) {
        $(this).rules("add", {
            messages: {
                lessThanEqual: $.validator.format("Must be less than or equal to {0}",$($(this).attr("lessThanEqual")).attr("label"))
            }
        });
    });
    $('body').on('click', '.add-entry', function() {
        addEntry($(this).parent().children('.template').first())
    });
    $('body').on('click', '.remove-entry', function() {
        removeEntry($(this).parent().children('.template').first())
    });
    var addEntry = function($template) {
	    var template_copy = $template.clone()
        var entries = $template.parent().children('.entries');
	    var max_entries = template_copy.attr('data-max-entries');
	    var min_entries = template_copy.attr('data-min-entries');
        var num_entries = entries.children().length;
        var root_id = $template.children().children().attr('name');
        var id = root_id + "-" + entries.children().length;

        if (max_entries && num_entries >= max_entries) return;
        template_copy.children().children().removeAttr('disabled');
        template_copy.children().children().attr('name', id);
        template_copy.children().children().find('[name]').each(function(){
            $(this).attr('name', $(this).attr('name').replace(root_id, id));
        });
        entries.append(template_copy.html());
        num_entries++;
        console.log(num_entries);
        console.log(min_entries);
        if (num_entries > 0 && (min_entries == undefined || num_entries > min_entries)) $template.parent().children('.remove-entry').removeAttr('disabled');
        if (max_entries !== undefined && num_entries >= max_entries) $template.parent().children('.add-entry').attr('disabled', 'disabled');
    };
    var removeEntry = function($template) {
	    var template_copy = $template.clone()
        var entries = $template.parent().children('.entries');
	    var min_entries = template_copy.attr('data-min-entries');
        var num_entries = entries.children().length;

        if (num_entries && num_entries <= min_entries) return;
        $template.parent().children('.add-entry').removeAttr('disabled');
	    entries.children().last().remove();
        if (num_entries - 1 == min_entries || num_entries - 1 <= 0) $template.parent().children('.remove-entry').attr('disabled', 'disabled');
    };
    $('.template').each(function(){
        var min_entries = $(this).attr('data-min-entries');
        for (i = 0; i < min_entries; i++) {
            addEntry($(this));
        }
    });
</script>