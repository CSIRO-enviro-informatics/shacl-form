{%- macro display_property(property) %}
{%- include "property.html" %}
{%- endmacro -%}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create New {{ form_name }}</title>
</head>
<body>
    <h1>Create New {{ form_name }}</h1>
    <form id="form">
        {%- for group in shape["groups"] %}
        <fieldset>
            <legend>{{ group["label"] }}</legend>
            {%- for property in group["properties"] %}
            {{ display_property(property)|indent(12) }}
            {%- endfor %}
        </fieldset>
        {%- endfor %}
        {%- for property in shape["properties"] %}
        {{ display_property(property)|indent(8) }}
        {%- endfor %}
        <input type="submit" value="Submit" />
    </form>
</body>
</html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="jquery-validation/jquery.validate.js"></script>
<script src="jquery-validation/additional-methods.js"></script>
<script>
    {#- Custom method for using equals with checkboxes #}
    $.validator.addMethod("equalToCheckbox", function(value, element, params) {
        if ($(element).is(":checked") == $(params).is(":checked"))
            return true;
        return false;
    }, "Message" );

    {#- Custom method notEqualTo #}
    $.validator.addMethod("notEqualTo", function(value, element, params) {
        if (this.optional(element) == true)
            return true;
        if ($(element).attr("type") == "checkbox")
            return $(element).is(":checked") == $(params).is(":checked") ? false : true;
        else
            return $(element).val() == $(params).val() ? false : true;
    }, "Message" );

    {#- Used to automatically add custom rules to relevant elements. Disabled fields are not validated #}
    $("#form").validate({
        ignore: ":input[disabled]",
        equalTo: ":input[equalTo]",
        equalToCheckbox: ":input[equalToCheckbox]",
        notEqualTo: ":input[notEqualTo]",
        lessThan: ":input[lessThan]",
        lessThanEqual: ":input[lessThanEqual]"
    });

    {#- Add pattern rule #}
    {%- for property in shape["properties"] %}
    {%- if "pattern" in property %}
    $("#" + $.escapeSelector("{{ property["path"] }}")).rules("add", {
        pattern: /{{ property["pattern"] }}/{{ property["flags"] }}
    });
    {%- endif %}
    {%- endfor %}
    {%- for group in shape["groups"] %} {% for property in group["properties"] %}
    {%- if "pattern" in property %}
    $("#" + $.escapeSelector("{{ property["path"] }}")).rules("add", {
        pattern: /{{ property["pattern"] }}/{{ property["flags"] }}
    });
    {%- endif %}
    {%- endfor %}
    {%- endfor %}

    {#- Sets the message for equalTo validation #}
    $(":input[equalTo]").each(function(index) {
        $(this).rules("add", {
            messages: { equalTo: $.validator.format("Must be equal to {0}",$($(this).attr("equalTo")).attr("label")) }
        });
    });

    {#- Sets the message for equalToCheckbox validation #}
    $(":input[equalToCheckbox]").each(function(index) {
        $(this).rules("add", {
            messages: {
                equalToCheckbox: $.validator.format("Must be equal to {0}",$($(this).attr("equalToCheckbox")).attr("label"))
            }
        });
    });

    {#- Sets the message for notEqualTo validation #}
    $(":input[notEqualTo]").each(function(index) {
        $(this).rules("add", {
            messages: {
                notEqualTo: $.validator.format("Must not be equal to {0}",$($(this).attr("notEqualTo")).attr("label"))
            }
        });
    });

    {#- Sets the message for lessThan validation #}
    $(":input[lessThan]").each(function(index) {
        $(this).rules("add", {
            messages: {
                lessThan: $.validator.format("Must be less than {0}",$($(this).attr("lessThan")).attr("label"))
            }
        });
    });

    {#- Sets the message for lessThanEquals validation #}
    $(":input[lessThanEqual]").each(function(index) {
        $(this).rules("add", {
            messages: {
                lessThanEqual: $.validator.format("Must be less than or equal to {0}",$($(this).attr("lessThanEqual")).attr("label"))
            }
        });
    });

    {#- Script for adding multiple fields for a property #}
    $('body').on('click', '.add-entry', function() {
        $(this).parent().children('.entries').append($(this).parent().children('.template').clone().html())
    });
    $('body').on('click', '.remove-entry', function() {
	    $(this).parent().children('.entries').children().last().remove()
    });
</script>